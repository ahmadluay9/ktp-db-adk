sources:
  cloud-sql-source:
    kind: cloud-sql-postgres
    project: ${GOOGLE_CLOUD_PROJECT}
    region: ${CLOUD_SQL_PG_REGION}
    instance: ${CLOUD_SQL_PG_INSTANCE}
    database: ${CLOUD_SQL_PG_DB}
    user: ${CLOUD_SQL_PG_USER}
    password: "${CLOUD_SQL_PG_PASSWORD}"

tools:
  # INSERTION TOOLS
  insert-ktp-record:
    kind: postgres-sql
    source: cloud-sql-source
    description: >
      Menambahkan data penduduk baru. Wajib mengisi kolom yang NOT NULL (NIK, Nama, Tempat/Tgl Lahir, Alamat). 
      Kolom expiry_date boleh diisi tanggal atau 'SEUMUR HIDUP'.
    parameters:
      - name: nik
        type: string
        description: "(NOT NULL) Nomor Induk Kependudukan 16 digit."
      - name: full_name
        type: string
        description: "(NOT NULL) Nama lengkap sesuai KTP."
      - name: birth_place
        type: string
        description: "(NOT NULL) Kota/Kabupaten tempat lahir."
      - name: birth_date
        type: string
        description: "(NOT NULL) Tanggal lahir. FORMAT WAJIB: YYYY-MM-DD (karena tipe data DATE)."
      - name: gender
        type: string
        description: "Jenis kelamin (LAKI-LAKI / PEREMPUAN)."
      - name: blood_type
        type: string
        description: "Golongan darah (A, B, AB, O, -)."
      - name: address
        type: string
        description: "(NOT NULL) Alamat jalan/komplek."
      - name: rt_rw
        type: string
        description: "RT dan RW (contoh: 005/002)."
      - name: village_kelurahan
        type: string
        description: "Kelurahan atau Desa."
      - name: district_kecamatan
        type: string
        description: "Kecamatan."
      - name: religion
        type: string
        description: "Agama (ISLAM, KRISTEN, KATOLIK, HINDU, BUDHA, KONGHUCU)."
      - name: marital_status
        type: string
        description: "Status (BELUM KAWIN, KAWIN, CERAI HIDUP, CERAI MATI)."
      - name: occupation
        type: string
        description: "Pekerjaan/Profesi."
      - name: citizenship
        type: string
        description: "Kewarganegaraan (WNI / WNA)."
      - name: expiry_date
        type: string
        description: "Tanggal berakhir masa berlaku. Boleh 'SEUMUR HIDUP' atau tanggal (DD-MM-YYYY)."
    statement: |
      INSERT INTO ktp_records (
        nik, full_name, birth_place, birth_date, gender, 
        blood_type, address, rt_rw, village_kelurahan, district_kecamatan, 
        religion, marital_status, occupation, citizenship, expiry_date, 
        created_at, updated_at
      ) VALUES (
        $1, $2, $3, $4::date, $5, 
        $6, $7, $8, $9, $10, 
        $11, $12, $13, $14, $15, 
        NOW(), NOW()
      );

  # RETRIEVAL TOOLS
  get-ktp-by-nik:
    kind: postgres-sql
    source: cloud-sql-source
    description: Mencari detail data KTP penduduk berdasarkan Nomor Induk Kependudukan (NIK).
    parameters:
      - name: nik
        type: string
        description: "Nomor NIK yang ingin dicari (contoh: 3171016703901110)."
    statement: |
      SELECT *
      FROM ktp_records
      WHERE nik = $1;

  search-ktp-by-name:
    kind: postgres-sql
    source: cloud-sql-source
    description: Mencari data KTP berdasarkan nama lengkap (pencarian tidak harus nama penuh/fuzzy search).
    parameters:
      - name: nama
        type: string
        description: "Nama atau sebagian nama penduduk (contoh: Lestari)."
    statement: |
      SELECT *
      FROM ktp_records
      WHERE full_name ILIKE '%' || $1 || '%'
      LIMIT 10;

  get-ktp-by-kecamatan:
    kind: postgres-sql
    source: cloud-sql-source
    description: Mengambil daftar penduduk yang tinggal di Kecamatan tertentu.
    parameters:
      - name: kecamatan
        type: string
        description: "Nama Kecamatan (contoh: Biringkanaya)."
    statement: |
      SELECT 
        nik, 
        full_name, 
        address, 
        village_kelurahan 
      FROM ktp_records
      WHERE district_kecamatan ILIKE '%' || $1 || '%'
      LIMIT 20;

  # AGGREGATE TOOLS
  agg-population-by-kecamatan:
    kind: postgres-sql
    source: cloud-sql-source
    description: Menampilkan statistik jumlah penduduk dikelompokkan berdasarkan Kecamatan.
    statement: |
      SELECT 
        district_kecamatan, 
        COUNT(*) as total_penduduk 
      FROM ktp_records 
      GROUP BY district_kecamatan 
      ORDER BY total_penduduk DESC;

  agg-distribution-by-religion:
    kind: postgres-sql
    source: cloud-sql-source
    description: Menampilkan statistik sebaran penduduk berdasarkan Agama.
    statement: |
      SELECT 
        religion, 
        COUNT(*) as total 
      FROM ktp_records 
      GROUP BY religion 
      ORDER BY total DESC;

  agg-distribution-by-marital-status:
    kind: postgres-sql
    source: cloud-sql-source
    description: Menampilkan statistik jumlah penduduk berdasarkan Status Perkawinan.
    statement: |
      SELECT 
        marital_status, 
        COUNT(*) as total 
      FROM ktp_records 
      GROUP BY marital_status 
      ORDER BY total DESC;

  agg-top-occupations:
    kind: postgres-sql
    source: cloud-sql-source
    description: Menampilkan 10 jenis pekerjaan terbanyak yang dimiliki penduduk.
    statement: |
      SELECT 
        occupation, 
        COUNT(*) as total 
      FROM ktp_records 
      GROUP BY occupation 
      ORDER BY total DESC 
      LIMIT 10;

toolsets:
  # Toolset for data management
  management_toolset:
    - insert-ktp-record

  # Toolset for finding specific people
  ktp_lookup_toolset:
    - get-ktp-by-nik
    - search-ktp-by-name
    - get-ktp-by-kecamatan

  # Toolset for statistical analysis
  aggregate_toolset:
    - agg-population-by-kecamatan
    - agg-distribution-by-religion
    - agg-distribution-by-marital-status
    - agg-top-occupations
